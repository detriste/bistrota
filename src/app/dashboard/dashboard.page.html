<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>
      <ion-icon name="water-outline" class="header-icon"></ion-icon>
      Qualidade da Água
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Monitoramento</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Filtro por Data -->
  <ion-card class="filter-card">
    <ion-card-header>
      <ion-card-title class="card-title-icon">
        <ion-icon name="calendar-outline" class="title-icon"></ion-icon>
        Filtrar por Data
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="button-group">
        <ion-button expand="block" (click)="toggleCalendario()" class="select-date-btn">
          <ion-icon slot="start" name="calendar"></ion-icon>
          {{ dataSelecionada ? formatarData(dataSelecionada) : 'Selecionar Data' }}
        </ion-button>
        <ion-button *ngIf="dataSelecionada" expand="block" fill="outline" color="medium" (click)="limparFiltro()" class="clear-filter-btn">
          <ion-icon slot="start" name="close-circle-outline"></ion-icon>
          Todos os Registros
        </ion-button>
      </div>
      <ion-datetime *ngIf="exibirCalendario" presentation="date" [(ngModel)]="dataSelecionada"
        (ionChange)="onDataChange($event)" locale="pt-BR" [max]="dataMaxima" class="datetime-custom">
      </ion-datetime>
      <div class="records-badge" *ngIf="dadosFiltrados.length > 0">
        <ion-icon name="document-text-outline"></ion-icon>
        <span>{{ dadosFiltrados.length }} registro(s) {{ dataSelecionada ? 'na data' : 'no total' }}</span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Gráficos e Estatísticas -->
  <ion-card class="chart-card" *ngIf="dadosGrafico.length > 0">
    <ion-card-header>
      <ion-card-title class="card-title-icon">
        <ion-icon name="stats-chart-outline" class="title-icon"></ion-icon>
        Análise em Tempo Real
      </ion-card-title>
    </ion-card-header>
    <ion-card-content class="chart-content">

      <!-- Estatísticas -->
      <div class="stats-grid">
        <div class="stat-box nivel">
          <div class="stat-icon"><ion-icon name="speedometer-outline"></ion-icon></div>
          <div class="stat-data">
            <p class="stat-label">Nível Médio</p>
            <p class="stat-value">{{ nivelMedia.toFixed(1) }}<span class="unit">%</span></p>
          </div>
        </div>
        <div class="stat-box ph">
          <div class="stat-icon"><ion-icon name="beaker-outline"></ion-icon></div>
          <div class="stat-data">
            <p class="stat-label">pH Médio</p>
            <p class="stat-value">{{ phMedia.toFixed(2) }}</p>
          </div>
        </div>
        <div class="stat-box turbidez">
          <div class="stat-icon"><ion-icon name="water-outline"></ion-icon></div>
          <div class="stat-data">
            <p class="stat-label">Turbidez</p>
            <p class="stat-value">{{ turbidezMedia.toFixed(1) }}<span class="unit"> NTU</span></p>
          </div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="charts-container">
        <!-- Nível da Água -->
        <div class="chart-wrapper">
          <h4 class="chart-title">
            <ion-icon name="speedometer-outline"></ion-icon>
            Nível da Água (%)
          </h4>
          <svg viewBox="0 0 420 200" class="chart-svg">
            <polyline [attr.points]="gerarPontosNivel()" fill="none" stroke="#22c55e" stroke-width="5" stroke-linecap="round"/>
            <circle *ngFor="let item of dadosGrafico; let i = index"
              [attr.cx]="40 + (i+1)*(340/(dadosGrafico.length+1))"
              [attr.cy]="160 - (item.nivel / 100)*140"
              r="5" [attr.fill]="getCorNivel(item.nivel)" (click)="mostrarTooltip(item, i, 'nivel')"/>
            <text x="20" y="165" font-size="11" fill="#666">0%</text>
            <text x="20" y="115" font-size="11" fill="#666">50%</text>
            <text x="20" y="65" font-size="11" fill="#666">100%</text>
          </svg>
        </div>

        <!-- pH -->
        <div class="chart-wrapper">
          <h4 class="chart-title">
            <ion-icon name="beaker-outline"></ion-icon>
            pH
          </h4>
          <svg viewBox="0 0 420 200" class="chart-svg">
            <polyline [attr.points]="gerarPontosPh()" fill="none" stroke="#a855f7" stroke-width="5"/>
            <circle *ngFor="let item of dadosGrafico; let i = index"
              [attr.cx]="40 + (i+1)*(340/(dadosGrafico.length+1))"
              [attr.cy]="160 - ((item.ph - 0) / 14)*140"
              r="5" [attr.fill]="getCorPh(item.ph)" (click)="mostrarTooltip(item, i, 'ph')"/>
            <text x="20" y="165" font-size="11" fill="#666">0</text>
            <text x="20" y="115" font-size="11" fill="#666">7</text>
            <text x="20" y="65" font-size="11" fill="#666">14</text>
          </svg>
        </div>

        <!-- Turbidez -->
        <div class="chart-wrapper">
          <h4 class="chart-title">
            <ion-icon name="water-outline"></ion-icon>
            Turbidez (NTU)
          </h4>
          <svg viewBox="0 0 420 200" class="chart-svg">
            <polyline [attr.points]="gerarPontosTurbidez()" fill="none" stroke="#06b6d4" stroke-width="5"/>
            <circle *ngFor="let item of dadosGrafico; let i = index"
              [attr.cx]="40 + (i+1)*(340/(dadosGrafico.length+1))"
              [attr.cy]="160 - (item.turbidez / 100)*140"
              r="5" [attr.fill]="getCorTurbidez(item.turbidez)" (click)="mostrarTooltip(item, i, 'turbidez')"/>
            <text x="20" y="165" font-size="11" fill="#666">0</text>
            <text x="20" y="115" font-size="11" fill="#666">50</text>
            <text x="20" y="65" font-size="11" fill="#666">100</text>
          </svg>
        </div>
      </div>

      <!-- Tooltip -->
      <div class="tooltip" *ngIf="tooltipVisivel" [style.left.px]="tooltipX" [style.top.px]="tooltipY">
        <strong>{{ tooltipValor }}{{ tooltipUnidade }}</strong><br>
        <small>{{ tooltipSensor }} • {{ tooltipHora }}</small>
      </div>

      <!-- Legenda -->
      <div class="chart-legend">
        <div class="legend-item"><span class="legend-dot nivel"></span><span>Nível</span></div>
        <div class="legend-item"><span class="legend-dot ph"></span><span>pH</span></div>
        <div class="legend-item"><span class="legend-dot turbidez"></span><span>Turbidez</span></div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Lista de Sensores -->
  <div *ngIf="dadosFiltrados.length > 0; else semDados" class="data-list" (click)="esconderTooltip()">
    <ion-card *ngFor="let item of dadosFiltradosVisiveis" class="sensor-card">
      <div class="card-header-custom">
        <div class="user-info">
          <div class="avatar-circle"><ion-icon name="hardware-chip-outline"></ion-icon></div>
          <div class="user-details">
            <h3>{{ item.nome }}</h3>
            <p class="timestamp"><ion-icon name="time-outline"></ion-icon> {{ formatarDataHora(item.timestamp) }}</p>
          </div>
        </div>
      </div>
      <ion-card-content>
        <div class="sensors-grid">
          <div class="sensor-box nivel">
            <div class="sensor-icon-wrapper"><ion-icon name="speedometer-outline"></ion-icon></div>
            <p class="sensor-label">Nível</p>
            <p class="sensor-value">{{ item.nivel }}<span class="unit">%</span></p>
          </div>
          <div class="sensor-box ph">
            <div class="sensor-icon-wrapper"><ion-icon name="beaker-outline"></ion-icon></div>
            <p class="sensor-label">pH</p>
            <p class="sensor-value">{{ item.ph }}</p>
          </div>
          <div class="sensor-box turbidez">
            <div class="sensor-icon-wrapper"><ion-icon name="water-outline"></ion-icon></div>
            <p class="sensor-label">Turbidez</p>
            <p class="sensor-value">{{ item.turbidez }}<span class="unit"> NTU</span></p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <div class="show-more-container" *ngIf="dadosFiltrados.length > 2">
      <ion-button expand="block" fill="outline" color="primary" (click)="toggleMostrarMais()" class="show-more-btn">
        <ion-icon slot="start" [name]="mostrarTodos ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
        {{ mostrarTodos ? 'Mostrar Menos' : 'Mostrar Mais (' + (dadosFiltrados.length - 2) + ')' }}
      </ion-button>
    </div>
  </div>

  <ng-template #semDados>
    <ion-card class="empty-state-card">
      <ion-card-content class="empty-state">
        <div class="empty-icon-wrapper"><ion-icon name="cloud-offline-outline"></ion-icon></div>
        <h2>Sem dados</h2>
        <p>Não há registros {{ dataSelecionada ? 'na data selecionada' : 'disponíveis' }}</p>
        <ion-button (click)="carregarDados()" expand="block" class="reload-btn">
          <ion-icon slot="start" name="refresh-outline"></ion-icon>
          Recarregar
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ng-template>
</ion-content>